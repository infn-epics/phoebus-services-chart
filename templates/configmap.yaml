apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "phoebus-services-chart.fullname" . }}-config
data:
  alarmlogger.properties: |-
    version=@project.version@
    server.port=8080

    spring.main.banner-mode=off
    spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration
    logging.level.root=WARN
    alarm_topics={{.Values.alarm.config | default "Accelerator"}}
    topics={{.Values.alarm.config | default "Accelerator"}}
    bootstrap.servers={{.Values.kafka.host}}:{{.Values.kafka.port}}

    es_host={{.Values.elasticsearch.network.host}}
    es_port=9200
    es_url={{.Values.elasticsearch.http.protocol | default "http"}}://{{.Values.elasticsearch.network.host}}:{{.Values.elasticsearch.http.port}}
    elasticsearch.network.host={{ .Values.elasticsearch.network.host }}
    elasticsearch.http.port={{ .Values.elasticsearch.http.port }}
    elasticsearch.http.protocol: {{ .Values.elasticsearch.protocol | default "http" }}
    elasticsearch.authorization.username={{ .Values.elasticsearch.authorization.username | default "" }}
    elasticsearch.authorization.password={{ .Values.elasticsearch.authorization.password | default "" }}
    # Max default size for es queries
    es_max_size=1000
    # Set to 'true' if sniffing to be enabled to discover other cluster nodes
    es_sniff=false

    # When set to true, the service will automatically create the index templates needed
    es_create_templates=true


    # Kafka client properties file
    kafka_properties=

    # A flag indicating if the service should use index names based on date/time generated periodically based on date_span_units
    use_dated_index_names=true

    # The units of the indices date span: Days (D), Weeks(W), Months(M), Years(Y).
    date_span_units=M

    # Size of the thread pool for message and command loggers. Two threads per topic/configuration are required
    thread_pool_size=4
    {{- if .Values.epicsConfiguration.gateway }}
      org.phoebus.pv.ca/addr_list={{ .Values.epicsConfiguration.gateway }}
    {{- else }}
    org.phoebus.pv.ca/addr_list={{ .Values.epicsConfiguration.ca_addr_list }}

    {{- end}}
    org.phoebus.pv.ca/auto_addr_list=false
    {{- if .Values.epicsConfiguration.pvagateway }}
      org.phoebus.pv.pva/epics_pva_name_servers={{ .Values.epicsConfiguration.pvagateway }}
    {{- else }}
      org.phoebus.pv.pva/epics_pva_name_servers={{ .Values.epicsConfiguration.pva_addr_list }}
    {{- end }}
    org.phoebus.pva/pva_auto_addr_list=false

    ############################## REST Logging ###############################
    # DEBUG level will log all requests and responses to and from the REST end points
    logging.level.org.springframework.web.filter.CommonsRequestLoggingFilter=DEBUG

    ############################## Index purge settings #######################
    # How many indices to retain (e.g. if you have selected date_span_units as M and set the retain_indices_count to 6, then indices
    # older than 6 months will be deleted.
    # Number of days computed form this setting and date_span_units must be greater or equal to 100
    # for automatic purge to be enabled.
    retain_indices_count=0

    # Cron expression used by Spring scheduler running automatic purge, default every Sunday at midnight.
    # See https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/support/CronExpression.html
    # Incorrect syntax will fail service startup if retention_period_days >= 100.
    purge_cron_expr=0 0 0 * * SUN
    ##############################################################################

  saveandrestore.properties: |-
      logging.level.root={{ .Values.service.loglevel}}
      logging.level.org.springframework={{ .Values.service.loglevel}}
      logging.level.org.apache.catalina={{ .Values.service.loglevel}}
      logging.level.org.apache.kafka={{ .Values.service.loglevel}}
      logging.level.org.springframework.web={{ .Values.service.loglevel}}
      logging.level.org.springframework.security={{ .Values.service.loglevel}}

      app.version=@project.version@
      app.name=@project.artifactId@

      # The server port for the rest service
      server.port=8080
      jca.use_env=true
      # Elasticsearch connection parameters
      elasticsearch.network.host={{ .Values.elasticsearch.network.host }}
      elasticsearch.http.port={{ .Values.elasticsearch.http.port }}
      elasticsearch.http.protocol: {{ .Values.elasticsearch.protocol | default "http" }}
      elasticsearch.authorization.username={{ .Values.elasticsearch.authorization.username | default "" }}
      elasticsearch.authorization.password={{ .Values.elasticsearch.authorization.password | default "" }}

      # Do not change this!
      spring.jackson.serialization.write-dates-as-timestamps=false

      server.servlet.contextPath=/save-restore
      elasticsearch.cluster.name: {{ .Values.elasticsearch.clusterName | default "elasticsearch" }}

      # The names of the index to use for save&restore
      elasticsearch.tree_node.index={{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_tree
      elasticsearch.configuration_node.index={{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_configuration
      elasticsearch.snapshot_node.index:{{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_snapshot
      elasticsearch.composite_snapshot_node.index:{{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_composite_snapshot
      elasticsearch.filter.index:{{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_filter

      ############################## REST Logging ###############################
      # {{ .Values.service.loglevel}} level will log all requests and responses to and from the REST end points
      logging.level.org.springframework.web.filter.CommonsRequestLoggingFilter={{ .Values.service.loglevel}}

      # Mapping of static resources. Needed as otherwise the web front-end (if present) will intercept and fail to
      # serve a resource like for instance SearchHelp.html
      spring.mvc.static-path-pattern=/**

      ############## AD - External ##############
      # ad.enabled = {{ .Values.ldap.external.enable }}
      # ad.url = {{ .Values.ldap.external.url }}
      # ad.domain = test.com

      ############## LDAP - External ##############
      # If uncommenting in this section, make sure
      # to comment out in LDAP - Embedded section
      #############################################
      #ldap.urls=ldaps://ldap-cslab.cslab.esss.lu.se
      #ldap.base.dn = dc=esss,dc=lu,dc=se
      #ldap.user.search.base=
      # User search pattern, e.g. uid={0},ou=People. No default value as LDAP environment may not
      # support user search by pattern.
      #ldap.user.dn.pattern=uid={0},ou=Users
      # User search filter, e.g. (&(objectClass=person)(SAMAccountName={0})). No default value as LDAP environment
      # may not support user search by filter.
      #ldap.user.search.filter=
      #ldap.groups.search.base = ou=Groups
      #ldap.groups.search.pattern = (memberUid= {1})
      # dn of manager account, may be required for group search
      # ldap.manager.dn=
      # password of account
      # ldap.manager.password=


      ############## LDAP - Embedded ##############
      # If uncommenting in this section, make sure
      # to comment out in LDAP - External section
      #############################################
      # ldap.urls=ldap://localhost:8389/dc=sar,dc=local
      # ldap.base.dn = dc=sar,dc=local
      # ldap.user.dn.pattern = uid={0},ou=Group
      # ldap.groups.search.base = ou=Group
      # ldap.groups.search.pattern = (memberUid= {1})
      spring.ldap.embedded.ldif=classpath:sar.ldif
      spring.ldap.embedded.base-dn=dc=sar,dc=local
      spring.ldap.embedded.port=8389 
      # spring.ldap.embedded.validation.enabled=false

      ############## Demo credentials ##############
      demo.user=epics
      demo.user.password=epics
      demo.admin=admin
      demo.admin.password=epics
      demo.readOnly=control
      demo.readOnly.password=1234

      ###### Bypass authorization (but not authentication!) #######
      authorization.permitall = true
      ############## Authentication Implementation ##############
      # Supported options:
      # ad - Microsoft AD
      # ldap - Probably Open LDAP
      # ldap_embedded - Embedded LDAP. Config in sar.ldif
      # demo - Hard coded, see WebSecurityConfig class
      auth.impl = demo

      ############## OAuth2 / JWT Authentication ##############
      # When enabled, requests with an Authorization: Bearer <token> header
      # are validated against the OIDC provider.
      oauth2.enabled = {{ .Values.saveandrestore.oauth2.enabled | default false }}
      oauth2.issueUri = {{ .Values.saveandrestore.oauth2.issueUri | default "https://localhost:8443/auth/realms/test" }}
      oauth2.claimsName = {{ .Values.saveandrestore.oauth2.claimsName | default "name" }}

      ###### Bypass authorization (but not authentication!) #######
      authorization.permitall = true

      ############## Authorization Roles ################

      role.user=sar-user
      role.admin=sar-admin
    
  olog.properties: |-
      # retrieve the version from the pom file
      olog.version=@project.version@

      # the server port for the rest service
      server.port: 8181

      # Options support for unsecure http
      server.http.enable=true
      server.http.port=8080

      # Disable the spring banner
      #spring.main.banner-mode=off

      # send the error messages along with the error code
      server.error.include-message=always

      ## oauth2/JWT
      oauth2.enabled = {{ .Values.oauth2.enabled }}
      oauth2.issueUri = {{ .Values.oauth2.issueUri }}
      oauth2.claimsName = {{ .Values.oauth2.claimsName }}

      # suppress the logging from spring boot
      # during {{ .Values.service.loglevel}}ging this should be set to {{ .Values.service.loglevel}}
      logging.level.root={{ .Values.service.loglevel}}
      logging.level.org.springframework={{ .Values.service.loglevel}}
      logging.level.org.apache.catalina={{ .Values.service.loglevel}}
      logging.level.org.apache.kafka={{ .Values.service.loglevel}}
      logging.level.org.springframework.web={{ .Values.service.loglevel}}
      logging.level.org.springframework.security={{ .Values.service.loglevel}}
      logging.level.org.springframework.messaging={{ .Values.service.loglevel}}
      logging.level.org.springframework.web.socket={{ .Values.service.loglevel}}

      spring.main.allow-bean-definition-overriding=true

      ############## SSL - Configuration ##############
      server.ssl.key-store-type=PKCS12
      server.ssl.key-store=classpath:keystore/newcf.p12
      server.ssl.key-store-password=password
      server.ssl.key-alias=cf

      security.require-ssl=false

      ############## Authorization Role --> group Mapping ##############
      # Customize group names here
      admin-groups=olog-admins,sys-admins,ADMIN
      log-groups=olog-logs,USER
      tag-groups=olog-tags,USER
      property-groups=olog-properties,USER
      logbook-groups=olog-logbooks,USER

      ############################## Elastic Search ###############################

      # Elasticsearch, by default, binds itself to the 0.0.0.0 address, and listens
      # on port [9200-9300] for HTTP traffic and on port [9300-9400] for node-to-node
      # communication. (the range means that if the port is busy, it will automatically
      # try the next port).
      # Set both 'bind_host' and 'publish_host':
      #
      elasticsearch.network.host: {{ .Values.elasticsearch.network.host }}

      # Set a custom port to listen for HTTP traffic:
      #
      elasticsearch.http.port: {{ .Values.elasticsearch.http.port }}
      elasticsearch.http.protocol: {{ .Values.elasticsearch.protocol | default "http" }}
      elasticsearch.authorization.username={{ .Values.elasticsearch.authorization.username | default "" }}
      elasticsearch.authorization.password={{ .Values.elasticsearch.authorization.password | default "" }}
      {{- if .Values.elasticsearch.pubcertsecret }}

      server.ssl.trust-store=/olog-target/truststore.jks
      server.ssl.trust-store-password=changeit
      {{- end }}
      # Set the name of the elastic cluster
      elasticsearch.cluster.name: {{ .Values.elasticsearch.clusterName | default "elasticsearch" }}

      # Create the Olog indices if they do not exist
      elasticsearch.create.indices: true

      # The names of the index to use for olog
      elasticsearch.tag.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_tags

      elasticsearch.logbook.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_logbooks

      elasticsearch.property.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_properties

      elasticsearch.log.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_logs

      elasticsearch.sequence.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_sequence

      elasticsearch.template.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_templates

      elasticsearch.level.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_levels

      # Archive modified log entries
      elasticsearch.log.archive.index: {{.Release.Namespace}}-{{ include "phoebus-services-chart.fullname" . }}_archived_logs

      ############################## Mongo gridfs client ###############################
      mongo.database: {{ .Values.mongo.database }}
      mongo.host: {{ .Values.mongo.host }}
      mongo.port: {{ .Values.mongo.port }}


      ############################## Spring Session repository configuration ##############################

      # For {{ .Values.service.loglevel}}ging purposes, set the below to true
      # spring.h2.console.enabled=true

      # Sets the maximum inactive interval, MUST be in minutes. Defaults to 30 if not set here.
      # If set to a negative value, the session never expires.
      # spring.session.timeout=30

      # URL for the H2 database. Defaults to in-memory, which means sessions are lost between restarts.
      # Use the below example to define a file-based URL.
      # spring.datasource.url=jdbc:h2:file:./olog-session;DB_CLOSE_ON_EXIT=TRUE

      ############################## CORS settings ##############################
      # Comma separated list of origins allowed to do CORS requests.
      # Defaults to http://localhost:3000 (NodeJS development), but must be augmented
      # with the origin(s) on which the web front-end is deployed.
      
    {{- if and .Values.cors .Values.cors.origins }}
      cors.allowed.origins={{.Values.cors.origins}}
      cors.allowed.methods={{.Values.cors.methods | default "GET,POST,PUT,DELETE,OPTIONS,PATCH"}}
      cors.allowed.headers={{.Values.cors.headers | default "*"}}
      cors.allow.credentials={{.Values.cors.credentials | default "true"}}
      cors.max.age={{.Values.cors.maxAge | default "3600"}}
    {{- end }}
    
      ################## File upload and request size limits ##################
      spring.servlet.multipart.max-file-size=50MB
      spring.servlet.multipart.max-request-size=100MB

      ################## List of "levels" ##################
      levels=Urgent,Suggestion,Info,Request,Problem

      ########### Elasticsearch "result set" sizes ##########
      # By default Elasticsearch will return 10 items matching a query.
      # This may bee too limiting, e.g. when client requests all tags.
      elasticsearch.result.size.logbooks=1000
      elasticsearch.result.size.tags=10000
      elasticsearch.result.size.properties=10000
      elasticsearch.result.size.levels=100
      # Default log entry search size if client does not set "limit" request parameter
      elasticsearch.result.size.search.default=100
      # Max log entry search size
      elasticsearch.result.size.search.max=1000

      # Default markup scheme
      defaultMarkup=commonmark

      # Timeout in milliseconds for PropertyProviders
      propertyProvidersTimeout=2000

      # Mapping of static resources
      spring.mvc.static-path-pattern=/Olog/**

      ########### Elasticsearch Default Logbooks, Tags, and Properties ##########
      default.logbook.url=
      default.tags.url=
      default.properties.url=
      default.levels.url=

      ########### OpenAPI / Swagger #############
      springdoc.api-docs.path=${API_PATH:/api/spec}
      springdoc.swagger-ui.path=${SWAGGER_PATH:/api/docs}
      springdoc.swagger-ui.disable-swagger-default-url=true
      springdoc.swagger-ui.displayOperationId=true

      ########### Wanted authentication providers #############
      # Supported values: inMemory, ldap, embeddedLdap, activeDirectory, jwt
      authenticationProviders={{ .Values.olog.authenticationProviders | default "inMemory,jwt" }}

      # Resources for the authentication providers
      embeddedLdapPropertySource=classpath:/security/embedded_ldap.properties
      ldapPropertySource=classpath:/security/ldap.properties
      activeDirectoryPropertySource=classpath:/security/active_directory.properties
      jwtPropertySource=classpath:/security/jwt.properties
  olog.ldif: |
      dn: dc=olog,dc=local
      objectClass: dcObject
      objectClass: organization
      dc: olog
      o: olog

      dn: cn=channelfinder,dc=olog,dc=local
      objectClass: simpleSecurityObject
      objectClass: organizationalRole
      userPassword:: e1NIQX1jUkR0cE5DZUJpcWw1S09Rc0tWeXJBMHNBaUE9
      cn: olog

      dn: ou=Group,dc=olog,dc=local
      objectClass: organizationalunit
      ou: Group
      description: groups branch

      dn: ou=People,dc=olog,dc=local
      objectClass: organizationalunit
      ou: People
      description: people branch

      dn: uid=tag,ou=People,dc=olog,dc=local
      uid: tag
      objectClass: account
      objectClass: posixAccount
      description: User with tag role
      cn: tag
      userPassword: 1234
      uidNumber: 23001
      gidNumber: 23001
      homeDirectory: /dev/null

      dn: uid=property,ou=People,dc=olog,dc=local
      uid: property
      objectClass: account
      objectClass: posixAccount
      description: User with property role
      cn: property
      userPassword: 1234
      uidNumber: 23002
      gidNumber: 23002
      homeDirectory: /dev/null

      dn: uid=epics,ou=People,dc=olog,dc=local
      uid: epics
      objectClass: account
      objectClass: posixAccount
      description: User with logbook role
      cn: logbook
      userPassword: epics
      uidNumber: 1000
      gidNumber: 1000
      homeDirectory: /dev/null

      dn: uid=log,ou=People,dc=olog,dc=local
      uid: log
      objectClass: account
      objectClass: posixAccount
      description: User with log role
      cn: log
      userPassword: 1234
      uidNumber: 23004
      gidNumber: 23004
      homeDirectory: /dev/null

      dn: uid=admin,ou=People,dc=olog,dc=local
      uid: admin
      objectClass: account
      objectClass: posixAccount
      description: User with admin role
      cn: admin
      userPassword: 1234
      uidNumber: 23005
      gidNumber: 23005
      homeDirectory: /dev/null

      dn: cn=olog-tags,ou=Group,dc=olog,dc=local
      cn: olog-tags
      objectClass: posixGroup
      description: olog-tags group
      gidNumber: 24001
      memberUid: tag

      dn: cn=olog-properties,ou=Group,dc=olog,dc=local
      cn: olog-properties
      objectClass: posixGroup
      description: olog-properties group
      gidNumber: 24002
      memberUid: property

      dn: cn=olog-logbooks,ou=Group,dc=olog,dc=local
      cn: olog-logbooks
      objectClass: posixGroup
      description: olog-logbooks group
      gidNumber: 24003
      memberUid: logbook

      dn: cn=olog-logs,ou=Group,dc=olog,dc=local
      cn: olog-logs
      objectClass: posixGroup
      description: olog-logs group
      gidNumber: 24004
      memberUid: log

      dn: cn=olog-admins,ou=Group,dc=olog,dc=local
      cn: olog-admins
      objectClass: posixGroup
      description: olog-admins group
      gidNumber: 24005
      memberUid: admin
  kafka.properties: |
      security.protocol=PLAINTEXT

  alarm.properties: |

      # Default java.util.logging configuration for alarm server
      #
      # Read in AlarmServerMain via LogManager

      handlers = java.util.logging.ConsoleHandler

      # Levels: SEVERE, WARNING, INFO, CONFIG, FINE, FINER, FINEST, ALL
      # General level 'FINE' to enable logging, which is then fine-tuned below
      .level = FINE

      java.util.logging.ConsoleHandler.level = ALL
      java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter
      # 1: date, 2: source, 3: logger, 4: level, 5: message, 6:thrown
      # Adding the logger name [%3$s] can be useful to determine which logger to _disable_,
      #
      java.util.logging.SimpleFormatter.format=%1$tY-%1$tm-%1$td %1$tH:%1$tM:%1$tS %4$s [%3$s] %5$s%6$s%n
      
      javax.activation.level = WARNING
      javax.mail.level = WARNING
      com.sun.mail.smtp.level = WARNING
      org.apache.kafka.level = INFO
      org.phoebus.applications.alarm/automated_email_sender={{.Release.Namespace}} Alarm Notifier
      org.phoebus.applications.alarm.level = INFO
      com.cosylab.epics.caj.level = DEBUG
      org.phoebus.framework.rdb.level = DEBUG
      org.phoebus.pv.level = DEBUG
      {{- if .Values.epicsConfiguration.gateway }}
      org.phoebus.pv.ca/addr_list={{ .Values.epicsConfiguration.gateway }}
      {{- else }}
      org.phoebus.pv.ca/addr_list={{ .Values.epicsConfiguration.ca_addr_list }}

      {{- end}}
      org.phoebus.pv.ca/auto_addr_list=false
      {{- if .Values.epicsConfiguration.pvagateway }}
        org.phoebus.pv.pva/epics_pva_name_servers={{ .Values.epicsConfiguration.pva_addr_list }}
      {{- else }}
        org.phoebus.pv.pva/epics_pva_name_servers={{ .Values.epicsConfiguration.pva_addr_list }}
      {{- end }}
      # Default PV protocol (ca for Channel Access, pva for PVAccess)
      org.phoebus.pv/default=ca
      
  sar.ldif: |
      dn: dc=sar,dc=local
      objectClass: dcObject
      objectClass: organization
      dc: sar
      o: sar

      dn: cn=sar,dc=sar,dc=local
      objectClass: simpleSecurityObject
      objectClass: organizationalRole
      userPassword:: e1NIQX1jUkR0cE5DZUJpcWw1S09Rc0tWeXJBMHNBaUE9
      cn: sar

      dn: ou=Group,dc=sar,dc=local
      objectClass: organizationalunit
      ou: Group
      description: groups branch

      dn: cn=sar-user,ou=Group,dc=sar,dc=local
      cn: sar-user
      objectClass: posixGroup
      description: save-n-restore user
      gidNumber: 27001
      uidNumber: 27001
      memberUid: user

      dn: cn=sar-admin,ou=Group,dc=sar,dc=local
      cn: sar-admin
      objectClass: posixGroup
      description: save-n-restore admin
      gidNumber: 27003
      uidNumber: 27003
      memberUid: admin

      dn: uid=epics,ou=Group,dc=sar,dc=local
      uid: epics
      objectClass: account
      objectClass: posixAccount
      description: User with sar-user role
      cn: user
      userPassword: epics
      uidNumber: 23004
      gidNumber: 23004
      homeDirectory: /dev/null

      dn: uid=johndoe,ou=Group,dc=sar,dc=local
      uid: johndoe
      objectClass: account
      objectClass: posixAccount
      description: User without sar roles
      cn: johndoe
      userPassword: 1234
      uidNumber: 23007
      gidNumber: 23007
      homeDirectory: /dev/null

      dn: uid=admin,ou=Group,dc=sar,dc=local
      uid: admin
      objectClass: account
      objectClass: posixAccount
      description: User with admin role
      cn: admin
      userPassword: epics
      uidNumber: 23005
      gidNumber: 23005
      homeDirectory: /dev/null



