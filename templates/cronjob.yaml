{{- if .Values.ologBackup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "phoebus-services-chart.fullname" . }}-backup
  labels:
    {{- include "phoebus-services-chart.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.ologBackup.schedule | quote }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "phoebus-services-chart.selectorLabels" . | nindent 12 }}
        spec:
          containers:
          - name: {{ include "phoebus-services-chart.fullname" . }}-backup
            image: {{ .Values.ologBackup.image }}
            command:
            - /bin/sh
            - -c
            - |
              # Install dependencies if needed
              pip install olog-tool

              # Generate timestamp for filenames
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)

              # Create backup
              olog-tool --url {{ .Values.ologBackup.ologUrl | quote }} --username {{ .Values.ologBackup.username | quote }} --password {{ .Values.ologBackup.password | quote }} backup --output /nfs/backups/backup_$TIMESTAMP

              # Generate reports
              olog-tool --url {{ .Values.ologBackup.ologUrl | quote }} --username {{ .Values.ologBackup.username | quote }} --password {{ .Values.ologBackup.password | quote }} markdown --output /nfs/documents/report_$TIMESTAMP.md --title "{{ .Values.ologBackup.title | quote }}  $TIMESTAMP"
              olog-tool --url {{ .Values.ologBackup.ologUrl | quote }} --username {{ .Values.ologBackup.username | quote }} --password {{ .Values.ologBackup.password | quote }} pdf --output /nfs/documents/report_$TIMESTAMP.pdf --title "{{ .Values.ologBackup.title | quote }}  $TIMESTAMP"
              olog-tool --url {{ .Values.ologBackup.ologUrl | quote }} --username {{ .Values.ologBackup.username | quote }} --password {{ .Values.ologBackup.password | quote }} html --output /nfs/documents/report.html --title "{{ .Values.ologBackup.title | quote }}  $TIMESTAMP"
            volumeMounts:
            {{- range .Values.nfsBackups }}
              - name: {{ .name }}
                mountPath: {{ .mountPath }}
            {{- end }}

          volumes:
            {{- range .Values.nfsBackups }}
              - name: {{ .name }}
                nfs:
                  server: {{ .server }}
                  path: {{ .path }}
            {{- end }}
          restartPolicy: OnFailure
{{- end }}